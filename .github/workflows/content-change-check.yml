name: Content Change Check

on:
  pull_request:
    paths:
      - 'ch*.html'

jobs:
  check-downstream-impact:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Identify changed chapters
        id: chapters
        run: |
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -oP 'ch\d+' | sort -u | tr '\n' ' ')
          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Check for companion resource updates
        id: check
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})

          HAS_CHAPTER=false
          HAS_VOCAB=false
          HAS_QUIZZES=false
          HAS_SLIDESHOWS=false
          HAS_SEARCH=false

          if echo "$CHANGED_FILES" | grep -qP '^ch\d+\.html$'; then
            HAS_CHAPTER=true
          fi

          if echo "$CHANGED_FILES" | grep -q 'vocabulary-cards.html'; then
            HAS_VOCAB=true
          fi

          if echo "$CHANGED_FILES" | grep -q 'quizzes.html'; then
            HAS_QUIZZES=true
          fi

          if echo "$CHANGED_FILES" | grep -q 'slideshows.html'; then
            HAS_SLIDESHOWS=true
          fi

          if echo "$CHANGED_FILES" | grep -q 'search-index.json'; then
            HAS_SEARCH=true
          fi

          echo "has_chapter=$HAS_CHAPTER" >> "$GITHUB_OUTPUT"
          echo "has_vocab=$HAS_VOCAB" >> "$GITHUB_OUTPUT"
          echo "has_quizzes=$HAS_QUIZZES" >> "$GITHUB_OUTPUT"
          echo "has_slideshows=$HAS_SLIDESHOWS" >> "$GITHUB_OUTPUT"
          echo "has_search=$HAS_SEARCH" >> "$GITHUB_OUTPUT"

      - name: Post reminder comment
        if: steps.check.outputs.has_chapter == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const hasVocab = '${{ steps.check.outputs.has_vocab }}' === 'true';
            const hasQuizzes = '${{ steps.check.outputs.has_quizzes }}' === 'true';
            const hasSlideshows = '${{ steps.check.outputs.has_slideshows }}' === 'true';
            const hasSearch = '${{ steps.check.outputs.has_search }}' === 'true';
            const chapters = '${{ steps.chapters.outputs.changed }}'.trim();

            let body = `### Content Change Detected\n\n`;
            body += `This PR modifies chapter files: **${chapters}**\n\n`;
            body += `When chapter text changes, companion resources may need updating too. `;
            body += `Please verify the checklist in the PR description.\n\n`;

            const items = [];
            if (!hasVocab) items.push('- [ ] Vocabulary cards (`vocabulary-cards.html`)');
            if (!hasQuizzes) items.push('- [ ] Quizzes (`quizzes.html`)');
            if (!hasSlideshows) items.push('- [ ] Slideshows (`slideshows.html`)');
            if (!hasSearch) items.push('- [ ] Search index (`js/search-index.json` â€” run `bash scripts/build_search_index.sh`)');

            if (items.length > 0) {
              body += `**Not updated in this PR:**\n${items.join('\n')}\n\n`;
              body += `If these don't need changes, no action required. If they do, please update them in this PR or open a follow-up issue.`;
            } else {
              body += `All companion resources appear to be included in this PR.`;
            }

            // Check if we already commented to avoid duplicates
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.data.find(c => c.body.includes('Content Change Detected'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
